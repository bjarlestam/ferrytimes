<!DOCTYPE html>

<html>
<head>
  <title>Sjöstadsfärjan - Tidtabell</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="keywords" content="ressel tidtabell färja båt hammarby sjöstad stockholm södermalm barnängsbryggan luma" />
    <meta name="description" content="Visar när nästa färja går mellan hammarby sjöstad och södermalm" />
    <link rel="apple-touch-icon" href="http://bjarlestam.github.com/ferrytimes/icon.png"/>
    <link rel="favicon" href="icon.png"/>
    
    <style>
    h2 {
      font-size: 1em;
      color: #AAA;
    }
    
    body {
      color: #F58B2F;
      font-family: "Arial";
      font-size: 3em;
    }

    #main {
      padding: 20px;
    	background: -webkit-gradient(linear, left top, left bottom, from(#DDDDDD), to(#FFFFFF));
    	background: -moz-linear-gradient(top,  #DDDDDD,  #FFFFFF);
    	filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#DDDDDD', endColorstr='#FFFFFF');

      margin: 0 auto;
      width: 80%;
      min-width: 500px;
    }
    
    .rounded {
      -moz-border-radius: 8px;
      -webkit-border-radius: 8px;
      border-radius: 8px;
    }

    #show_timetable_from_luma, #show_timetable_to_luma {
      height: 50px;
      width: 50px;
      margin-left: 2em;
      background-color: #AAA;
      display: inline-block;
      background-image: url('list.png');
      background-repeat: no-repeat;
    }
    
    .timetable {
      z-index: 100;
      width: 50%;
      position: absolute;
      top: 1em;
      background: #444;
      padding: 1em;
    }
    
    .nextDeparture {
      color: white;
    }
        
    </style>
</head>
<body>
  <div id="main" class="rounded">
  <h2>Nästa färja från sjöstan</h2>
  <div>
    <span id="from_luma"></span><span id="show_timetable_from_luma" class="rounded"></span>
  </div>
  <h2>Nästa färja till sjöstan</h2>
  <div>
    <span id="to_luma"></span><span id="show_timetable_to_luma" class="rounded"></span>
  </div>
  
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript">

    $(document).ready(function() {
      var DEPARTURES_FROM_LUMA_WEEKDAYS = {
        '6': [5, 25, 45],
        '7': [5, 15, 25, 35, 45, 55],
        '8': [5, 15, 25, 35, 45, 55],
        '9': [5, 25, 45],
        '10': [5, 25, 45],
        '11': [5, 25, 45],
        '12': [5, 25, 45],
        '13': [5, 25, 45],
        '14': [5, 25, 45],
        '15': [5, 25, 45],
        '16': [5, 15, 25, 35, 45, 55],
        '17': [5, 15, 25, 35, 45, 55],
        '18': [5, 25, 45],
        '19': [5, 25, 45],
        '20': [5,	25,	45],
        '21': [5,	25,	45],
        '22': [5, 25, 45],
        '23': [5, 25, 45],
        '0': [5]
      };

      var DEPARTURES_FROM_LUMA_WEEKENDS = {
        '6': [5, 25, 45],
        '7': [5, 25, 45],
        '8': [5,25, 45],
        '9': [5, 25, 45],
        '10': [5, 25, 45],
        '11': [5, 25, 45],
        '12': [5, 25, 45],
        '13': [5, 25, 45],
        '14': [5, 25, 45],
        '15': [5, 25, 45],
        '16': [5, 25, 45],
        '17': [5, 25, 45],
        '18': [5, 25, 45],
        '19': [5, 25, 45],
        '20': [5,	25,	45],
        '21': [5,	25,	45],
        '22': [5, 25, 45],
        '23': [5, 25, 45],
        '0': [5]
      };


      var DEPARTURES_TO_LUMA_WEEKDAYS = {
          '6': [0, 20, 40],
          '7': [0, 10, 20, 30, 40, 50],
          '8': [0, 10, 20, 30, 40, 50],
          '9': [0, 20, 40],
          '10': [0, 20, 40],
          '11': [0, 20, 40],
          '12': [0, 20, 40],
          '13': [0, 20, 40],
          '14': [0, 20, 40],
          '15': [0, 20, 40],
          '16': [0, 10, 20, 30, 40, 50],
          '17': [0, 10, 20, 30, 40, 50],
          '18': [0, 20, 40],
          '19': [0, 20, 40],
          '20': [0, 20, 40],
          '21': [0, 20, 40],
          '22': [0, 20, 40],
          '23': [0, 20, 40],
          '0': [0]
        };

        var DEPARTURES_TO_LUMA_WEEKENDS = {
            '6': [0, 20, 40],
            '7': [0, 20, 40],
            '8': [0, 20, 40],
            '9': [0, 20, 40],
            '10': [0, 20, 40],
            '11': [0, 20, 40],
            '12': [0, 20, 40],
            '13': [0, 20, 40],
            '14': [0, 20, 40],
            '15': [0, 20, 40],
            '16': [0, 20, 40],
            '17': [0, 20, 40],
            '18': [0, 20, 40],
            '19': [0, 20, 40],
            '20': [0, 20, 40],
            '21': [0, 20, 40],
            '22': [0, 20, 40],
            '23': [0, 20, 40],
            '0': [0]
          };
  

      
      function pad(time) {
        if(time < 10) {
          return '0'+time;
        } else {
          return time;
        }
      }
      
      function minuteOrMinutes(minutes) {
        return (minutes == 1)?' minut':' minuter';
      }
      
      function minutesToDeparture(now, departureTime) {
        var milliseconds = departureTime.getTime() - now.getTime();
        return Math.round(milliseconds/60000);
      }
      
      function nextDepartureThisHour(departures, departureTime) {
        for(var index in departures) {
          if(departures[index] > departureTime.getMinutes()) {
            return departures[index];
          }
        }
        return undefined;
      }
      
      function nextDeparture(departureMatrix, now) {
        var departureTime = new Date(now);
        var nextDeparture;
        while(nextDeparture === undefined) {
          
          if(departureMatrix[departureTime.getHours()] === undefined) {
            departureTime.setHours(6);
            hour = 6;
          }

          var departures = departureMatrix[departureTime.getHours()];
          nextDeparture = nextDepartureThisHour(departures, departureTime);

          if(nextDeparture === undefined) {
            if(departureTime.getHours() === 23) {
              departureTime.setDate(departureTime.getDate() + 1);
              departureTime.setHours(0);
            } else {
              departureTime.setHours(departureTime.getHours() + 1);
            }
            departureTime.setMinutes(0);
          } else {
            departureTime.setMinutes(nextDeparture);
          }
        }
        return departureTime;
      }
      
      function departuresThisDay(departures_weekdays, departures_weekends, now) {
        if(now.getDay() === 6 || now.getDay() === 7) {
          return departures_weekends;
        } else {
          return departures_weekdays;
        }
      }

      function showNextDeparture(departures_weekdays, departures_weekends, now, selector) {
        var departures = departuresThisDay(departures_weekdays, departures_weekends, now);
        var next = nextDeparture(departures, now);
        var minutes = minutesToDeparture(now, next);
        $(selector).text(pad(next.getHours()) + ':' + pad(next.getMinutes()) + 
        '   -   ' + minutes + minuteOrMinutes(minutes));
        
      }

      var now = new Date();
      showNextDeparture(DEPARTURES_FROM_LUMA_WEEKDAYS, DEPARTURES_FROM_LUMA_WEEKENDS, now, '#from_luma');
      showNextDeparture(DEPARTURES_TO_LUMA_WEEKDAYS, DEPARTURES_TO_LUMA_WEEKENDS, now, '#to_luma');
      
      
      
      function buildTimetable(departures_weekdays, departures_weekends) {
        var timetable = $('<div class="timetable rounded"></div>');
        var now = new Date();
        var departures = departuresThisDay(departures_weekdays, departures_weekends, now);
        
        var next = nextDeparture(departures, now);
        
        var departuresInHour = departures[next.getHours()];
        addToTimetable(timetable, next.getHours(), departuresInHour, next);
        if(departures[next.getHours() + 1]) {
          var departuresNextHour = departures[next.getHours() + 1];
          addToTimetable(timetable, next.getHours()+1, departuresNextHour);
        }
        return timetable;
      }
      
      function addToTimetable(timetable, hour, departures, next) {
        for(var index in departures) {
          var row = $('<div>' + pad(hour) + ':' + pad(departures[index]) + '</div>');
          if(next && (departures[index] === next.getMinutes())) {
            row.addClass('nextDeparture');
          }
          timetable.append(row);
        }
        return timetable;
      }
      
      function addTimetableButtonEvent(button, departures_weekdays, departures_weekends) {
        $(button).click(function() {
          var timetable = buildTimetable(departures_weekdays, departures_weekends);
          timetable.insertAfter(button);
          setTimeout(function(){
            $('body').one('click', function(e) {
              timetable.remove();
              return false;
            });
          }, 100);
        });
      }
      
      addTimetableButtonEvent('#show_timetable_from_luma', DEPARTURES_FROM_LUMA_WEEKDAYS, DEPARTURES_FROM_LUMA_WEEKENDS);
      addTimetableButtonEvent('#show_timetable_to_luma', DEPARTURES_TO_LUMA_WEEKDAYS, DEPARTURES_TO_LUMA_WEEKENDS);
      
      
    });
    
  </script>
</body>
